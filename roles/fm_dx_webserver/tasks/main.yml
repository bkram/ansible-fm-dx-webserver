---
- name: Install  nodejs, and npm
  ansible.builtin.apt:
    name:
      - nodejs
      - npm
      - ffmpeg
    state: present
    update_cache: true
  become: true

- name: Add the current user to the audio group
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    groups: audio
    append: true
  become: true

- name: Create /opt/fm-dx-webserver directory
  ansible.builtin.file:
    path: /opt/fm-dx-webserver
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0755"
  become: true

- name: Clone or update the fm-dx-webserver repo from GitHub
  ansible.builtin.git:
    repo: https://github.com/NoobishSVK/fm-dx-webserver.git
    dest: /opt/fm-dx-webserver
    version: main
    update: true
    force: true
  notify: Restart fm-dx-webserver

- name: Install npm dependencies in the fm-dx-webserver-main directory
  community.general.npm:
    path: /opt/fm-dx-webserver/fm-dx-webserver/
    state: present
  notify: Restart fm-dx-webserver

- name: Check if fm-dx-webserver config file exists
  ansible.builtin.stat:
    path: /opt/fm-dx-webserver/config.json
  register: config_file

- name: Create fm-dx-webserver config on first install
  ansible.builtin.template:
    src: config.json.j2
    dest: /opt/fm-dx-webserver/config.json
    mode: "0644"
  notify: Restart fm-dx-webserver
  when: not config_file.stat.exists

- name: Deploy fm-dx-webserver.service from template
  ansible.builtin.template:
    src: fm-dx-webserver.service.j2
    dest: /etc/systemd/system/fm-dx-webserver.service
    mode: "0644"
  become: true
  notify:
    - Reload systemd daemon
    - Restart fm-dx-webserver

- name: Ensure fm-dx-webserver service is started and enabled
  ansible.builtin.systemd:
    name: fm-dx-webserver
    enabled: true
  become: true
  notify: Restart fm-dx-webserver
